!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.mp3Recorder=t():e.mp3Recorder=t()}(self,(function(){return function(){"use strict";var e={767:function(e,t,i){function n(){function e(e,t){return new Promise(((i,n)=>{const r=new XMLHttpRequest;r.open("GET",e),r.responseType="arraybuffer",r.onload=()=>{i(WebAssembly.instantiate(r.response,t))},r.onerror=n,r.send()}))}let t=null,i=5242880;function n(e){const t=i;return i+=e,t}function r(e){postMessage({type:"internal-error",data:e})}let a=null,s=null,o=null;onmessage=i=>{const c=i.data;switch(c.type){case"init":const{wasmURL:i,shimURL:h}=c.data;Promise.resolve().then((()=>(self.WebAssembly&&!function(){const e=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),t=new WebAssembly.Module(e);return 0!==new WebAssembly.Instance(t,{}).exports.test(4)}()&&delete self.WebAssembly,self.WebAssembly||importScripts(h),t=new WebAssembly.Memory({initial:256,maximum:256}),{memory:t,pow:Math.pow,exit:r,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:n}))).then((t=>function(t,i){if(!WebAssembly.instantiateStreaming)return e(t,i);const n=fetch(t,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(n,i).catch((n=>{if(n.message&&n.message.indexOf("Argument 0 must be provided and must be a Response")>0)return e(t,i);throw n}))}(i,{env:t}))).then((e=>{a=e.instance.exports,postMessage({type:"init",data:null})})).catch((e=>{postMessage({type:"init-error",data:e.toString()})}));break;case"start":if(!function(e){if(s=a.vmsg_init(e),!s)return!1;const i=new Uint32Array(t.buffer,s,1)[0];return o=new Float32Array(t.buffer,i),!0}(c.data))return postMessage({type:"error",data:"vmsg_init"});break;case"data":if(l=c.data,o.set(l),!(a.vmsg_encode(s,l.length)>=0))return postMessage({type:"error",data:"vmsg_encode"});break;case"stop":const u=function(){if(a.vmsg_flush(s)<0)return null;const e=new Uint32Array(t.buffer,s+4,1)[0],i=new Uint32Array(t.buffer,s+8,1)[0],n=new Uint8Array(t.buffer,e,i),r=new Blob([n],{type:"audio/mpeg"});return a.vmsg_free(s),s=null,o=null,r}();if(!u)return postMessage({type:"error",data:"vmsg_flush"});postMessage({type:"stop",data:u})}var l}}i.d(t,{default:function(){return r}});class r{constructor(e={},t=null){this.wasmURL=new URL(e.wasmURL||"js/vmsg.wasm",location).href,this.shimURL=new URL(e.shimURL||"js/wasm-polyfill.js",location).href,this.onStop=t,this.pitch=e.pitch||0,this.stream=null,this.audioCtx=null,this.gainNode=null,this.pitchFX=null,this.encNode=null,this.worker=null,this.workerURL=null,this.blob=null,this.blobURL=null,this.resolve=null,this.reject=null,Object.seal(this)}close(){this.encNode&&this.encNode.disconnect(),this.encNode&&(this.encNode.onaudioprocess=null),this.stream&&this.stopTracks(),this.audioCtx&&this.audioCtx.close(),this.worker&&(this.worker.terminate(),this.worker=null),this.workerURL&&URL.revokeObjectURL(this.workerURL),this.blobURL&&URL.revokeObjectURL(this.blobURL)}initAudio(){return(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?function(e){return navigator.mediaDevices.getUserMedia(e)}:function(e){const t=navigator.webkitGetUserMedia||navigator.mozGetUserMedia;return t?new Promise((function(i,n){t.call(navigator,e,i,n)})):Promise.reject(new Error("getUserMedia is not implemented in this browser"))})({audio:!0}).then((e=>{this.stream=e;const t=this.audioCtx=new(window.AudioContext||window.webkitAudioContext),i=t.createMediaStreamSource(e),n=this.gainNode=(t.createGain||t.createGainNode).call(t);n.gain.value=1,i.connect(n);const r=this.pitchFX=new c(t);r.setPitchOffset(this.pitch);const a=this.encNode=(t.createScriptProcessor||t.createJavaScriptNode).call(t,0,1,1);r.output.connect(a),n.connect(0===this.pitch?a:r.input)}))}initWorker(){if(this.worker)return Promise.resolve();const e=new Blob(["(",n.toString(),")()"],{type:"application/javascript"}),t=this.workerURL=URL.createObjectURL(e),i=this.worker=new Worker(t),{wasmURL:r,shimURL:a}=this;return i.postMessage({type:"init",data:{wasmURL:r,shimURL:a}}),new Promise(((e,t)=>{i.onmessage=i=>{const n=i.data;switch(n.type){case"init":e();break;case"init-error":this.close(),t(new Error(n.data));break;case"error":case"internal-error":this.close(),console.error("Worker error:",n.data),this.reject&&this.reject(n.data);break;case"stop":this.blob=n.data,this.blobURL=URL.createObjectURL(n.data),this.onStop&&this.onStop(),this.resolve&&this.resolve(this.blob)}}}))}init(){return this.initAudio().then(this.initWorker.bind(this))}startRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");this.blob=null,this.blobURL&&URL.revokeObjectURL(this.blobURL),this.blobURL=null,this.resolve=null,this.reject=null,this.worker.postMessage({type:"start",data:this.audioCtx.sampleRate}),this.encNode.onaudioprocess=e=>{const t=e.inputBuffer.getChannelData(0);this.worker.postMessage({type:"data",data:t})},this.encNode.connect(this.audioCtx.destination)}stopRecording(){if(!this.stream)throw new Error("missing audio initialization");if(!this.worker)throw new Error("missing worker initialization");return this.encNode.disconnect(),this.encNode.onaudioprocess=null,this.audioCtx.close(),this.worker.postMessage({type:"stop",data:null}),new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}stopTracks(){this.stream.getTracks&&this.stream.getTracks().forEach((e=>e.stop()))}}const a=.05,s=.1;function o(e,t,i,n){for(var r=t*e.sampleRate,a=r+(t-2*i)*e.sampleRate,s=e.createBuffer(1,a,e.sampleRate),o=s.getChannelData(0),c=0;c<r;++c)o[c]=n?(r-c)/a:c/r;for(c=r;c<a;++c)o[c]=0;return s}function c(e){this.context=e;var t=(e.createGain||e.createGainNode).call(e),i=(e.createGain||e.createGainNode).call(e);this.input=t,this.output=i;var n=e.createBufferSource(),r=e.createBufferSource(),c=e.createBufferSource(),l=e.createBufferSource();this.shiftDownBuffer=o(e,s,a,!1),this.shiftUpBuffer=o(e,s,a,!0),n.buffer=this.shiftDownBuffer,r.buffer=this.shiftDownBuffer,c.buffer=this.shiftUpBuffer,l.buffer=this.shiftUpBuffer,n.loop=!0,r.loop=!0,c.loop=!0,l.loop=!0;var h=(e.createGain||e.createGainNode).call(e),u=(e.createGain||e.createGainNode).call(e),f=(e.createGain||e.createGainNode).call(e);f.gain.value=0;var d=(e.createGain||e.createGainNode).call(e);d.gain.value=0,n.connect(h),r.connect(u),c.connect(f),l.connect(d);var p=(e.createGain||e.createGainNode).call(e),m=(e.createGain||e.createGainNode).call(e),b=(e.createDelay||e.createDelayNode).call(e),g=(e.createDelay||e.createDelayNode).call(e);h.connect(p),u.connect(m),f.connect(p),d.connect(m),p.connect(b.delayTime),m.connect(g.delayTime);var w=e.createBufferSource(),v=e.createBufferSource(),y=function(e,t,i){for(var n=.1*e.sampleRate,r=n+0*e.sampleRate,a=e.createBuffer(1,r,e.sampleRate),s=a.getChannelData(0),o=.05*e.sampleRate,c=o,l=n-o,h=0;h<n;++h){var u;u=h<c?Math.sqrt(h/o):h>=l?Math.sqrt(1-(h-l)/o):1,s[h]=u}for(h=n;h<r;++h)s[h]=0;return a}(e);w.buffer=y,v.buffer=y,w.loop=!0,v.loop=!0;var R=(e.createGain||e.createGainNode).call(e),U=(e.createGain||e.createGainNode).call(e);R.gain.value=0,U.gain.value=0,w.connect(R.gain),v.connect(U.gain),t.connect(b),t.connect(g),b.connect(R),g.connect(U),R.connect(i),U.connect(i);var G=e.currentTime+.05,k=G+s-a;n.start(G),r.start(k),c.start(G),l.start(k),w.start(G),v.start(k),this.mod1=n,this.mod2=r,this.mod1Gain=h,this.mod2Gain=u,this.mod3Gain=f,this.mod4Gain=d,this.modGain1=p,this.modGain2=m,this.fade1=w,this.fade2=v,this.mix1=R,this.mix2=U,this.delay1=b,this.delay2=g,this.setDelay(.1)}c.prototype.setDelay=function(e){this.modGain1.gain.setTargetAtTime(.5*e,0,.01),this.modGain2.gain.setTargetAtTime(.5*e,0,.01)},c.prototype.setPitchOffset=function(e){e>0?(this.mod1Gain.gain.value=0,this.mod2Gain.gain.value=0,this.mod3Gain.gain.value=1,this.mod4Gain.gain.value=1):(this.mod1Gain.gain.value=1,this.mod2Gain.gain.value=1,this.mod3Gain.gain.value=0,this.mod4Gain.gain.value=0),this.setDelay(.1*Math.abs(e))}}},t={};function i(n){if(t[n])return t[n].exports;var r=t[n]={exports:{}};return e[n](r,r.exports,i),r.exports}return i.d=function(e,t){for(var n in t)i.o(t,n)&&!i.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i(767)}().default}));
